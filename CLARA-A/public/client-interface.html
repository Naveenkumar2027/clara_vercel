<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Interface - Sai Vidya Institute of Technology</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .institute-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        /* Chat Styles */
        .chat-container {
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: #667eea;
            color: white;
        }

        .message.user .message-avatar {
            background: #48bb78;
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 70%;
        }

        .message.user .message-content {
            text-align: right;
        }

        .message-text {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            line-height: 1.4;
        }

        .message.bot .message-text {
            background: #667eea;
            color: white;
        }

        .message.user .message-text {
            background: #48bb78;
            color: white;
        }

        .message-time {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .message.user .message-time {
            text-align: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .chat-input button:hover {
            background: #5a67d8;
        }

        .call-request-btn {
            background: #48bb78 !important;
            margin-left: 10px;
        }

        .call-request-btn:hover {
            background: #38a169 !important;
        }

        .call-request-btn:disabled {
            background: #a0aec0 !important;
            cursor: not-allowed;
        }

        /* Video Call Display Styles */
        .video-call-display {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-call-display.hidden {
            display: none;
        }

        .video-call-content {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .video-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #16213e;
        }

        .video-call-header .caller-info h3 {
            color: white;
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .video-call-header .caller-info p {
            color: #94a3b8;
            margin: 0;
            font-size: 14px;
        }

        .video-container {
            background: #0f172a;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            border: 1px solid #16213e;
        }

        .video-placeholder {
            color: #cbd5e1;
        }

        .video-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .video-placeholder p {
            margin: 5px 0;
            font-size: 16px;
        }

        #clientVideoCallStatus {
            color: #10b981;
            font-weight: 600;
        }

        /* Call Offer Styles */
        .call-offer {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .call-offer h3 {
            color: #38a169;
            margin-bottom: 10px;
        }

        .call-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        /* Video Call Styles */
        .video-call-section {
            background: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            color: white;
        }

        .video-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .video-call-status {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .video-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .video-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .video-btn.end {
            background: #f56565;
            color: white;
        }

        .video-btn.mute {
            background: #718096;
            color: white;
        }

        .video-btn.video {
            background: #718096;
            color: white;
        }

        /* QR Code Styles */
        .qr-section {
            text-align: center;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            margin: 15px 0;
        }

        .qr-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .qr-code {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: inline-block;
        }

        .appointment-details {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .appointment-details h4 {
            color: #2b6cb0;
            margin-bottom: 10px;
        }

        .appointment-details p {
            margin: 5px 0;
            color: #4a5568;
        }

        /* Status Styles */
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        .status.info {
            background: #ebf8ff;
            color: #3182ce;
            border: 1px solid #bee3f8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="institute-logo">üè´</div>
            <h1>Sai Vidya Institute of Technology</h1>
            <p>Welcome! I'm Clara, your AI receptionist. How can I help you today?</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Section -->
            <div class="card">
                <h2>üí¨ Chat with Clara</h2>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be added here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()">Send</button>
                        <button id="callRequestButton" class="call-request-btn" onclick="requestVideoCall()" disabled>
                            <i class="fas fa-video"></i> Call
                        </button>
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-panel">
                <!-- Status Section -->
                <div class="card">
                    <h2>üìä Status</h2>
                    <div id="statusSection">
                        <div class="status info">Ready to help you!</div>
                    </div>
                </div>

                <!-- Staff Selection Section -->
                <div class="card">
                    <h2>üë• Start Conversation</h2>
                    <div id="staffSelectorContainer">
                        <!-- Staff Selector will be rendered here -->
                    </div>
                </div>

                <!-- Call Offer Section -->
                <div class="card hidden" id="callOfferSection">
                    <h2>üìû Video Call</h2>
                    <div id="callOfferContent">
                        <!-- Call offer content will be added here -->
                    </div>
                </div>

                <!-- Video Call Section -->
                <div class="card hidden" id="videoCallSection">
                    <h2>üìπ Video Call</h2>
                    <div class="video-call-section">
                        <div class="video-call-header">
                            <div class="video-call-status" id="videoCallStatus">Connecting...</div>
                        </div>
                        <div class="video-controls">
                            <button class="video-btn mute" onclick="toggleMute()">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="video-btn video" onclick="toggleVideo()">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="video-btn end" onclick="endCall()">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- QR Code Section -->
                <div class="card hidden" id="qrCodeSection">
                    <h2>üì± Appointment QR Code</h2>
                    <div class="qr-section">
                        <h3>Your appointment has been confirmed!</h3>
                        <div class="qr-code">
                            <canvas id="qrCode"></canvas>
                        </div>
                        <div class="appointment-details" id="appointmentDetails">
                            <!-- Appointment details will be added here -->
                        </div>
                        <p>Scan this QR code with your mobile device to view appointment details.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentCall = null;
        let isMuted = false;
        let isVideoOff = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            addWelcomeMessage();
        });

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateStatus('Connected to Clara AI', 'success');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateStatus('Disconnected from server', 'error');
            });

            // Handle call offers
            socket.on('incoming-call-request', (data) => {
                console.log('Call offer received:', data);
                showCallOffer({
                    message: `Connect with ${data.staffName}? Purpose: ${data.purpose}`,
                    staff: { id: data.callId } // we will pass callId forward
                });
            });

            // Handle call responses
            socket.on('call_response', (data) => {
                console.log('Call response:', data);
                if (data.accepted) {
                    updateStatus('Call accepted! Starting video call...', 'success');
                    startVideoCall(data);
                } else {
                    updateStatus('Call was rejected', 'error');
                    hideCallOffer();
                }
            });

            // Handle call ended
            socket.on('call-ended', (data) => {
                console.log('Call ended:', data);
                updateStatus(`Call ended: ${data.reason}`, 'error');
                cleanupCall();
                updateStatus('Waiting for staff decision on appointment...', 'info');
            });

            // Handle appointment decision
            socket.on('appointment_decision', (data) => {
                console.log('Appointment decision received:', data);
                if (data.approved) {
                    updateStatus('Appointment approved! Generating QR code...', 'success');
                } else {
                    updateStatus('Appointment rejected. Please contact us for alternative arrangements.', 'error');
                    setTimeout(() => {
                        startNewConversation();
                    }, 3000);
                }
            });

            // Handle QR code generation
            socket.on('qr_code_generated', async (data) => {
                console.log('QR code generated:', data);
                try {
                    // Generate QR code image
                    const qrCodeElement = document.getElementById('qrCode');
                    await QRCode.toCanvas(qrCodeElement, data.qrCodeData, {
                        width: 180,
                        margin: 2
                    });

                    // Show appointment details
                    const appointmentDetails = document.getElementById('appointmentDetails');
                    appointmentDetails.innerHTML = `
                        <h4>Appointment Details</h4>
                        <p><strong>Staff:</strong> ${data.appointmentDetails.staffName}</p>
                        <p><strong>Date:</strong> ${data.appointmentDetails.date}</p>
                        <p><strong>Time:</strong> ${data.appointmentDetails.time}</p>
                        <p><strong>Purpose:</strong> ${data.appointmentDetails.purpose}</p>
                        <p><strong>Location:</strong> ${data.appointmentDetails.location}</p>
                    `;

                    // Show QR code section
                    document.getElementById('qrCodeSection').classList.remove('hidden');

                    // Update status
                    updateStatus('Appointment confirmed! QR code generated successfully.', 'success');

                    // Start new conversation after showing QR code
                    setTimeout(() => {
                        startNewConversation();
                    }, 5000);

                } catch (error) {
                    console.error('Error generating QR code:', error);
                    updateStatus('Error generating QR code. Please try again.', 'error');
                }
            });

            // Handle AI response with enhanced video call functionality
            socket.on('ai-response', (data) => {
                try {
                    console.log('ü§ñ AI Response:', data);
                    
                    // Display the response
                    displayMessage('clara', data.response);
                    
                    // Handle video call request mode
                    if (data.isVideoCallRequest) {
                        showVideoCallOptions(data.staffInfo);
                    }
                    
                    // Handle video call accepted
                    if (data.isVideoCallAccepted) {
                        showVideoCallAccepted(data.staffInfo);
                    }
                    
                    // Handle video call rejected
                    if (data.isVideoCallRejected) {
                        showVideoCallRejected(data.staffInfo);
                    }
                    
                    // Handle exit from demo mode
                    if (data.exitDemoMode) {
                        hideVideoCallOptions();
                    }
                    
                    // Handle video call request that was accepted
                    if (data.isVideoCallAccepted && data.staffInfo) {
                        // Send video call request to staff
                        socket.emit('video-call-request', {
                            staffName: data.staffInfo.name,
                            staffEmail: data.staffInfo.email,
                            staffDepartment: data.staffInfo.department,
                            clientName: currentUser.name || 'Client',
                            clientSocketId: socket.id
                        });
                    }
                    
                } catch (error) {
                    console.error('Error handling AI response:', error);
                    displayMessage('clara', 'I apologize, but I encountered an error. Please try again.');
                }
            });

            // Handle video call request sent
            socket.on('video-call-request-sent', (data) => {
                try {
                    console.log('üì§ Video call request sent:', data);
                    updateStatus(`Video call request sent to ${data.staffName}. Waiting for response...`, 'info');
                    
                    // Show waiting indicator
                    showWaitingForStaff();
                    
                } catch (error) {
                    console.error('Error handling video call request sent:', error);
                }
            });

            // Handle video call accepted by staff
            socket.on('video-call-accepted', (data) => {
                try {
                    console.log('‚úÖ Video call accepted by staff:', data);
                    updateStatus(`üéâ ${data.staffName} accepted your video call request!`, 'success');
                    
                    // Hide waiting indicator
                    hideWaitingForStaff();
                    
                    // Show video call interface
                    showVideoCallInterface(data.staffName);
                    
                } catch (error) {
                    console.error('Error handling video call accepted:', error);
                }
            });

            // Handle video call rejected by staff
            socket.on('video-call-rejected', (data) => {
                try {
                    console.log('‚ùå Video call rejected by staff:', data);
                    updateStatus(`‚ùå ${data.staffName} is not available for video calls right now.`, 'warning');
                    
                    // Hide waiting indicator
                    hideWaitingForStaff();
                    
                    // Show alternative options
                    showAlternativeOptions(data.staffName);
                    
                } catch (error) {
                    console.error('Error handling video call rejected:', error);
                }
            });

            // Handle Clara AI reset to full mode
            socket.on('clara-ai-reset', (data) => {
                try {
                    console.log('üîÑ Clara AI reset to full mode:', data);
                    displayMessage('clara', data.message);
                    
                    // Hide any video call related UI
                    hideVideoCallOptions();
                    hideWaitingForStaff();
                    hideVideoCallInterface();
                    
                } catch (error) {
                    console.error('Error handling Clara AI reset:', error);
                }
            });

            // New email-based call system event listeners
            socket.on('call-request-sent', (data) => {
                console.log('üìû Call request sent:', data);
                updateStatus(data.message, 'info');
            });

            socket.on('call-response', (data) => {
                console.log('üìû Call response received:', data);
                const callRequestButton = document.getElementById('callRequestButton');
                
                if (data.accepted) {
                    updateStatus('Call accepted! Starting video call...', 'success');
                    // Here you would start the actual video call
                    setTimeout(() => {
                        window.location.href = '/video-client';
                    }, 2000);
                } else {
                    updateStatus('Call declined', 'warning');
                    callRequestButton.disabled = false;
                    callRequestButton.innerHTML = '<i class="fas fa-video"></i> Call';
                }
            });

            socket.on('call-request-error', (data) => {
                console.log('‚ùå Call request error:', data);
                updateStatus(data.message, 'error');
                const callRequestButton = document.getElementById('callRequestButton');
                callRequestButton.disabled = false;
                callRequestButton.innerHTML = '<i class="fas fa-video"></i> Call';
            });

            // WebRTC call response handler
            socket.on('webrtc-call-response', (data) => {
                console.log('üé• WebRTC call response received:', data);
                const callRequestButton = document.getElementById('callRequestButton');
                
                if (data.accepted) {
                    updateStatus('WebRTC call accepted! Starting video call...', 'success');
                    // Show video call display instead of redirecting
                    showClientVideoCallDisplay(data);
                } else {
                    updateStatus('WebRTC call declined', 'warning');
                    callRequestButton.disabled = false;
                    callRequestButton.innerHTML = '<i class="fas fa-video"></i> Call';
                }
            });

            // Handle call completed with QR code
            socket.on('call-completed-qr', (data) => {
                try {
                    console.log('üì± Call completed with QR code:', data);
                    
                    // Display QR code
                    showQRCode(data.qrCode, data.message);
                    
                    // Update status
                    updateStatus('Call completed! QR code generated.', 'success');
                    
                } catch (error) {
                    console.error('Error handling call completed QR:', error);
                }
            });

            // Handle initiate video call
            socket.on('initiate-video-call', (data) => {
                try {
                    console.log('üé• Initiating video call:', data);
                    
                    // Send video call request to staff
                    socket.emit('video-call-request', {
                        staffName: data.staffName,
                        staffEmail: data.staffEmail,
                        staffDepartment: data.staffDepartment,
                        clientName: data.clientName,
                        clientSocketId: data.clientSocketId
                    });
                    
                } catch (error) {
                    console.error('Error initiating video call:', error);
                }
            });
        }

        // Add welcome message
        function addWelcomeMessage() {
            const messagesContainer = document.getElementById('chatMessages');
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'message bot';
            welcomeMessage.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Hi there! I'm Clara, your friendly AI receptionist at Sai Vidya Institute of Technology! üòä 
                        I can help you with information about our staff, their availability, and even connect you with them via video call. 
                        How can I assist you today?
                    </div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            messagesContainer.appendChild(welcomeMessage);
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                
                // Send to server
                socket.emit('chat_message', {
                    message: message,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Request video call with specific staff
        function requestVideoCall() {
            // Find the selected staff from the conversation context
            const selectedStaff = getSelectedStaffFromContext();
            if (!selectedStaff) {
                updateStatus('Please select a staff member first by mentioning them in the chat', 'error');
                return;
            }

            const callRequestButton = document.getElementById('callRequestButton');
            callRequestButton.disabled = true;
            callRequestButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calling...';

            // Send call request using new email-based system
            socket.emit('call-request', {
                clientId: currentUser?.id || 'client_' + Date.now(),
                staffEmail: selectedStaff.email
            });

            updateStatus(`Call request sent to ${selectedStaff.name}...`, 'info');
        }

        // Helper function to get selected staff from conversation context
        function getSelectedStaffFromContext() {
            // This would typically come from the conversation context
            // For now, we'll use a simple approach to find staff mentioned in recent messages
            const messages = document.querySelectorAll('.message-text');
            for (let i = messages.length - 1; i >= 0; i--) {
                const messageText = messages[i].textContent.toLowerCase();
                // Look for staff names in recent messages
                if (messageText.includes('anitha') || messageText.includes('prof. anitha')) {
                    return { name: 'Prof. Anitha C S', email: 'anithacs@gmail.com' };
                }
                if (messageText.includes('lakshmi') || messageText.includes('prof. lakshmi')) {
                    return { name: 'Prof. Lakshmi Durga N', email: 'lakshmidurga@gmail.com' };
                }
                if (messageText.includes('dhivyasri') || messageText.includes('dr. g dhivyasri')) {
                    return { name: 'Dr. G Dhivyasri', email: 'gdhivyasri@gmail.com' };
                }
            }
            return null;
        }

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Add message to chat
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
            const time = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-text">${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Check if a staff member was mentioned and enable call button
            if (sender === 'bot') {
                checkForStaffMention(text);
            }
        }

        // Check if a staff member was mentioned in the message
        function checkForStaffMention(messageText) {
            const lowerText = messageText.toLowerCase();
            const staffNames = ['anitha', 'prof. anitha', 'lakshmi', 'prof. lakshmi', 'dhivyasri', 'dr. g dhivyasri'];
            
            const mentionedStaff = staffNames.find(name => lowerText.includes(name));
            if (mentionedStaff) {
                enableCallButton();
            }
        }

        // Enable the call button
        function enableCallButton() {
            const callButton = document.getElementById('callRequestButton');
            if (callButton) {
                callButton.disabled = false;
                callButton.innerHTML = '<i class="fas fa-video"></i> Call';
            }
        }

        // Show call offer
        function showCallOffer(data) {
            const callOfferSection = document.getElementById('callOfferSection');
            const callOfferContent = document.getElementById('callOfferContent');
            
            callOfferContent.innerHTML = `
                <div class="call-offer">
                    <h3>üìû Video Call Request</h3>
                    <p>${data.message}</p>
                    <div class="call-actions">
                        <button class="btn btn-success" onclick="acceptCall('${data.staff.id}')">Accept Call</button>
                        <button class="btn btn-danger" onclick="rejectCall()">Decline</button>
                    </div>
                </div>
            `;
            
            callOfferSection.classList.remove('hidden');
            updateStatus('Video call request received', 'info');
        }

        // Hide call offer
        function hideCallOffer() {
            document.getElementById('callOfferSection').classList.add('hidden');
        }

        // Accept call
        function acceptCall(callId) {
            socket.emit('accept-call-request', {
                callId: callId,
                clientName: 'Visitor',
                purpose: 'Video call via Clara'
            });
            
            hideCallOffer();
            updateStatus('Call accepted! Connecting...', 'success');
        }

        // Reject call
        function rejectCall() {
            // No-op to server for now; UI feedback only
            
            hideCallOffer();
            updateStatus('Call declined', 'info');
        }

        // Start video call
        function startVideoCall(data) {
            currentCall = data;
            document.getElementById('videoCallSection').classList.remove('hidden');
            document.getElementById('videoCallStatus').textContent = `Connected with ${data.staffName}`;
            updateStatus('Video call in progress', 'success');
        }

        // End call
        function endCall() {
            if (currentCall) {
                socket.emit('end_call', {
                    callId: currentCall.callId,
                    reason: 'Ended by user'
                });
                cleanupCall();
            }
        }

        // Cleanup call
        function cleanupCall() {
            currentCall = null;
            document.getElementById('videoCallSection').classList.add('hidden');
            document.getElementById('qrCodeSection').classList.add('hidden');
        }

        // Toggle mute
        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.querySelector('.video-btn.mute i');
            muteBtn.className = isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
            updateStatus(isMuted ? 'Microphone muted' : 'Microphone unmuted', 'info');
        }

        // Toggle video
        function toggleVideo() {
            isVideoOff = !isVideoOff;
            const videoBtn = document.querySelector('.video-btn.video i');
            videoBtn.className = isVideoOff ? 'fas fa-video-slash' : 'fas fa-video';
            updateStatus(isVideoOff ? 'Video turned off' : 'Video turned on', 'info');
        }

        // Update status
        function updateStatus(message, type) {
            const statusSection = document.getElementById('statusSection');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            // Remove old status messages
            const oldStatuses = statusSection.querySelectorAll('.status');
            oldStatuses.forEach(status => status.remove());
            
            statusSection.appendChild(statusDiv);
        }

        // Start new conversation
        function startNewConversation() {
            // Clear chat messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Add welcome message
            addWelcomeMessage();
            
            // Hide all sections
            document.getElementById('callOfferSection').classList.add('hidden');
            document.getElementById('videoCallSection').classList.add('hidden');
            document.getElementById('qrCodeSection').classList.add('hidden');
            
            updateStatus('Ready to help you!', 'info');
        }

        // Video Call Workflow Functions
        function showVideoCallOptions(staffInfo) {
            // Create video call options modal
            const modal = document.createElement('div');
            modal.className = 'video-call-modal';
            modal.innerHTML = `
                <div class="video-call-modal-content">
                    <h3>üé• Video Call Request for ${staffInfo.name}</h3>
                    <p>I understand you'd like to have a video call with ${staffInfo.name} from the ${staffInfo.department} department.</p>
                    <p>I'll request a video call connection for you. Please choose an option:</p>
                    <div class="video-call-buttons">
                        <button class="btn btn-success" onclick="acceptVideoCall('${staffInfo.name}')">
                            ‚úÖ Accept - Connect me to ${staffInfo.name}
                        </button>
                        <button class="btn btn-danger" onclick="rejectVideoCall()">
                            ‚ùå Reject - Cancel this request
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add styles
            if (!document.getElementById('video-call-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'video-call-modal-styles';
                styles.textContent = `
                    .video-call-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .video-call-modal-content {
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        max-width: 500px;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    }
                    .video-call-buttons {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                        margin-top: 20px;
                    }
                    .video-call-buttons .btn {
                        padding: 15px 20px;
                        font-size: 16px;
                        border-radius: 10px;
                        border: none;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    .btn-success {
                        background: #48bb78;
                        color: white;
                    }
                    .btn-success:hover {
                        background: #38a169;
                        transform: translateY(-2px);
                    }
                    .btn-danger {
                        background: #e53e3e;
                        color: white;
                    }
                    .btn-danger:hover {
                        background: #c53030;
                        transform: translateY(-2px);
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function hideVideoCallOptions() {
            const modal = document.querySelector('.video-call-modal');
            if (modal) {
                modal.remove();
            }
        }

        function acceptVideoCall(staffName) {
            // Send accept message to Clara AI
            sendMessage(`accept`);
            
            // Hide the modal
            hideVideoCallOptions();
            
            // Show success message
            updateStatus(`üéâ Video call request accepted! Connecting to ${staffName}...`, 'success');
        }

        function rejectVideoCall() {
            // Send reject message to Clara AI
            sendMessage(`reject`);
            
            // Hide the modal
            hideVideoCallOptions();
            
            // Show cancellation message
            updateStatus('‚ùå Video call request cancelled.', 'info');
        }

        // Video call display functions for client
        function showClientVideoCallDisplay(callData) {
            const videoDisplay = document.getElementById('videoCallDisplay');
            const videoCallerName = document.getElementById('clientVideoCallerName');
            const videoCallerDetails = document.getElementById('clientVideoCallerDetails');
            const videoCallStatus = document.getElementById('clientVideoCallStatus');
            
            videoCallerName.textContent = `Video Call - ${callData.staffName || 'Staff'}`;
            videoCallerDetails.textContent = `Call ID: ${callData.callId}`;
            videoCallStatus.textContent = 'Connected';
            
            videoDisplay.classList.remove('hidden');
            videoDisplay.style.display = 'flex';
        }

        function endClientVideoCall() {
            const videoDisplay = document.getElementById('videoCallDisplay');
            videoDisplay.classList.add('hidden');
            videoDisplay.style.display = 'none';
            
            showNotification('Video call ended', 'info');
        }

        function showWaitingForStaff() {
            // Create waiting indicator
            const waitingDiv = document.createElement('div');
            waitingDiv.id = 'waitingForStaff';
            waitingDiv.className = 'waiting-indicator';
            waitingDiv.innerHTML = `
                <div class="waiting-content">
                    <div class="spinner"></div>
                    <h3>‚è≥ Waiting for Staff Response</h3>
                    <p>Your video call request has been sent. Please wait while the staff member responds...</p>
                </div>
            `;
            
            document.body.appendChild(waitingDiv);
            
            // Add styles
            if (!document.getElementById('waiting-indicator-styles')) {
                const styles = document.createElement('style');
                styles.id = 'waiting-indicator-styles';
                styles.textContent = `
                    .waiting-indicator {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .waiting-content {
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        text-align: center;
                        max-width: 400px;
                    }
                    .spinner {
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function hideWaitingForStaff() {
            const waitingDiv = document.getElementById('waitingForStaff');
            if (waitingDiv) {
                waitingDiv.remove();
            }
        }

        function showVideoCallInterface(staffName) {
            // Show the existing video call section
            const videoCallSection = document.getElementById('videoCallSection');
            if (videoCallSection) {
                videoCallSection.classList.remove('hidden');
                document.getElementById('videoCallStatus').textContent = `Connected with ${staffName}`;
            }
        }

        function hideVideoCallInterface() {
            const videoCallSection = document.getElementById('videoCallSection');
            if (videoCallSection) {
                videoCallSection.classList.add('hidden');
            }
        }

        function showAlternativeOptions(staffName) {
            // Show alternative contact options
            displayMessage('clara', `Since ${staffName} is not available for video calls right now, here are some alternatives:\n\n` +
                `üìß **Email**: You can send an email to ${staffName}\n` +
                `üìû **Phone**: Contact the department office\n` +
                `üìù **Message**: Leave a message and I'll forward it\n\n` +
                `Would you like me to help you with any of these alternatives?`);
        }

        function showQRCode(qrCode, message) {
            // Create QR code display modal
            const modal = document.createElement('div');
            modal.className = 'qr-code-modal';
            modal.innerHTML = `
                <div class="qr-code-modal-content">
                    <h3>üì± Call Completed - QR Code Generated</h3>
                    <p>${message}</p>
                    <div class="qr-code-display">
                        <div class="qr-code-placeholder">
                            <h4>QR Code Data:</h4>
                            <pre>${JSON.stringify(qrCode, null, 2)}</pre>
                            <p><small>Note: This is a demo QR code. In production, this would be a scannable image.</small></p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="closeQRCode()">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add styles
            if (!document.getElementById('qr-code-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'qr-code-modal-styles';
                styles.textContent = `
                    .qr-code-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .qr-code-modal-content {
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        max-width: 600px;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    }
                    .qr-code-display {
                        margin: 20px 0;
                        padding: 20px;
                        background: #f7fafc;
                        border-radius: 10px;
                        border: 1px solid #e2e8f0;
                    }
                    .qr-code-placeholder pre {
                        background: #2d3748;
                        color: #e2e8f0;
                        padding: 15px;
                        border-radius: 8px;
                        overflow-x: auto;
                        text-align: left;
                        font-size: 12px;
                    }
                    .btn-primary {
                        background: #4299e1;
                        color: white;
                        padding: 12px 24px;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s ease;
                    }
                    .btn-primary:hover {
                        background: #3182ce;
                        transform: translateY(-1px);
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function closeQRCode() {
            const modal = document.querySelector('.qr-code-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Staff Selector Integration
        let staffSelector = null;
        let currentSession = null;

        function initializeStaffSelector() {
            const container = document.getElementById('staffSelectorContainer');
            if (!container) return;

            // Render StaffSelector component
            const staffSelectorElement = React.createElement(StaffSelector, {
                onStaffSelected: handleStaffSelected,
                socket: socket
            });

            ReactDOM.render(staffSelectorElement, container);
        }

        function handleStaffSelected(sessionData) {
            console.log('Staff selected:', sessionData);
            currentSession = sessionData;
            
            // Update status
            updateStatus(`Connected to ${sessionData.staffName}`, 'success');
            
            // Show session info
            showSessionInfo(sessionData);
        }

        function showSessionInfo(sessionData) {
            const statusSection = document.getElementById('statusSection');
            statusSection.innerHTML = `
                <div class="status success">
                    <strong>Connected to ${sessionData.staffName}</strong><br>
                    <small>Session: ${sessionData.sessionId.slice(0, 8)}...</small><br>
                    <small>Purpose: ${sessionData.purpose}</small>
                </div>
            `;
        }

        // Initialize staff selector when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            addWelcomeMessage();
            
            // Initialize staff selector after a short delay
            setTimeout(() => {
                initializeStaffSelector();
            }, 1000);
        });
    </script>

    <!-- Staff Selector Component Script -->
    <script src="/components/StaffSelector.js"></script>

    <!-- Video Call Display -->
    <div id="videoCallDisplay" class="video-call-display hidden">
        <div class="video-call-content">
            <div class="video-call-header">
                <div class="caller-info">
                    <h3 id="clientVideoCallerName">Video Call</h3>
                    <p id="clientVideoCallerDetails">Connected with Staff</p>
                </div>
                <button class="call-btn decline" onclick="endClientVideoCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            <div class="video-container">
                <div class="video-placeholder">
                    <div class="video-icon">üìπ</div>
                    <p>Video Call Active</p>
                    <p id="clientVideoCallStatus">Connecting...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
