<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Timetable - Staff Interface</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .timetable-cell {
            transition: all 0.2s ease;
        }
        .timetable-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .break-cell {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }
        .lunch-cell {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
        }
        .coffee-cell {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            border-color: #8b5cf6;
        }
        .subject-cell {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: #22c55e;
        }
        .lab-cell {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            border-color: #ef4444;
        }
        .editing {
            background: linear-gradient(135deg, #fef3c7, #fde68a) !important;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { motion, AnimatePresence } = Motion;

        // Timetable data
        const timetableData = [
            {
                "semester": "V",
                "class": "CSE (Data Science)",
                "section": "A",
                "academic_year": "2025-26",
                "room": "224",
                "timetable": [
                    {
                        "day": "Monday",
                        "slots": [
                            {
                                "start_time": "08:30",
                                "end_time": "09:25",
                                "subject_code": "BCD501",
                                "subject_name": "Software Engineering & Project Management",
                                "faculty": "Prof. Lakshmi Durga N(LDN)"
                            },
                            {
                                "start_time": "09:25",
                                "end_time": "10:20",
                                "subject_code": "BRMK557",
                                "subject_name": "Research Methodology and IPR",
                                "faculty": "Prof. Anitha C S(ACS)"
                            },
                            {
                                "start_time": "10:20",
                                "end_time": "10:40",
                                "subject_code": null,
                                "subject_name": "Coffee Break",
                                "faculty": null
                            },
                            {
                                "start_time": "10:40",
                                "end_time": "11:35",
                                "subject_code": "BCD502",
                                "subject_name": "Computer Networks",
                                "faculty": "Dr. G Dhivyasri (GD)"
                            },
                            {
                                "start_time": "11:35",
                                "end_time": "12:30",
                                "subject_code": "BCD515C",
                                "subject_name": "NOSQL Databases",
                                "faculty": "Prof. Nisha S K (NSK)"
                            },
                            {
                                "start_time": "12:30",
                                "end_time": "13:15",
                                "subject_code": null,
                                "subject_name": "Lunch Break",
                                "faculty": null
                            },
                            {
                                "start_time": "13:15",
                                "end_time": "14:10",
                                "subject_code": "BCD586",
                                "subject_name": "Mini Project",
                                "faculty": "Prof. Amarnath B Patil (ABP)"
                            },
                            {
                                "start_time": "14:10",
                                "end_time": "15:05",
                                "subject_code": "BCD586",
                                "subject_name": "Mini Project",
                                "faculty": "Prof. Amarnath B Patil (ABP)"
                            },
                            {
                                "start_time": "15:05",
                                "end_time": "16:10",
                                "subject_code": "BCD586",
                                "subject_name": "Mini Project",
                                "faculty": "Prof. Amarnath B Patil (ABP)"
                            }
                        ]
                    },
                    {
                        "day": "Tuesday",
                        "slots": [
                            {
                                "start_time": "08:30",
                                "end_time": "09:25",
                                "subject_code": "BCD502",
                                "subject_name": "Computer Networks",
                                "faculty": "Dr. G Dhivyasri (GD)"
                            },
                            {
                                "start_time": "09:25",
                                "end_time": "10:20",
                                "subject_code": "BCD515C",
                                "subject_name": "NOSQL Databases",
                                "faculty": "Prof. Nisha S K (NSK)"
                            },
                            {
                                "start_time": "10:20",
                                "end_time": "10:40",
                                "subject_code": null,
                                "subject_name": "Coffee Break",
                                "faculty": null
                            },
                            {
                                "start_time": "10:40",
                                "end_time": "11:35",
                                "subject_code": "BCD503",
                                "subject_name": "Theory of Computation",
                                "faculty": "Dr. Nagashree N (NN)"
                            },
                            {
                                "start_time": "11:35",
                                "end_time": "12:30",
                                "subject_code": "BES 508",
                                "subject_name": "Environmental Studies",
                                "faculty": "Prof. Anil Kumar K V (AKV)"
                            },
                            {
                                "start_time": "12:30",
                                "end_time": "13:15",
                                "subject_code": null,
                                "subject_name": "Lunch Break",
                                "faculty": null
                            },
                            {
                                "start_time": "13:15",
                                "end_time": "14:10",
                                "subject_code": "BCDL504",
                                "subject_name": "Computer Networks Lab",
                                "faculty": "Prof. Anitha CS(ACS) / Prof. Jyoti Kumari(JK)"
                            },
                            {
                                "start_time": "14:10",
                                "end_time": "15:05",
                                "subject_code": "BCDL504",
                                "subject_name": "Computer Networks Lab",
                                "faculty": "Prof. Anitha CS(ACS) / Prof. Jyoti Kumari(JK)"
                            },
                            {
                                "start_time": "15:05",
                                "end_time": "16:10",
                                "subject_code": "BCDL504",
                                "subject_name": "Computer Networks Lab",
                                "faculty": "Prof. Anitha CS(ACS) / Prof. Jyoti Kumari(JK)"
                            }
                        ]
                    },
                    {
                        "day": "Wednesday",
                        "slots": [
                            {
                                "start_time": "08:30",
                                "end_time": "09:25",
                                "subject_code": "BCDL504",
                                "subject_name": "Data Visualization Lab",
                                "faculty": "Prof. Lakshmi Durga N(LDN)/Prof. Vidyashree R(VR)"
                            },
                            {
                                "start_time": "09:25",
                                "end_time": "10:20",
                                "subject_code": "BCDL504",
                                "subject_name": "Data Visualization Lab",
                                "faculty": "Prof. Lakshmi Durga N(LDN)/Prof. Vidyashree R(VR)"
                            },
                            {
                                "start_time": "10:20",
                                "end_time": "10:40",
                                "subject_code": null,
                                "subject_name": "Coffee Break",
                                "faculty": null
                            },
                            {
                                "start_time": "10:40",
                                "end_time": "11:35",
                                "subject_code": "BCDL504",
                                "subject_name": "Data Visualization Lab",
                                "faculty": "Prof. Lakshmi Durga N(LDN)/Prof. Vidyashree R(VR)"
                            },
                            {
                                "start_time": "11:35",
                                "end_time": "12:30",
                                "subject_code": "BCD503",
                                "subject_name": "Theory of Computation",
                                "faculty": "Dr. Nagashree N (NN)"
                            },
                            {
                                "start_time": "12:30",
                                "end_time": "13:15",
                                "subject_code": null,
                                "subject_name": "Lunch Break",
                                "faculty": null
                            },
                            {
                                "start_time": "13:15",
                                "end_time": "14:10",
                                "subject_code": "BCD502",
                                "subject_name": "Computer Networks",
                                "faculty": "Dr. G Dhivyasri (GD)"
                            },
                            {
                                "start_time": "14:10",
                                "end_time": "15:05",
                                "subject_code": "BRMK557",
                                "subject_name": "Research Methodology and IPR",
                                "faculty": "Prof. Anitha C S(ACS)"
                            },
                            {
                                "start_time": "15:05",
                                "end_time": "16:10",
                                "subject_code": null,
                                "subject_name": "Placement Training",
                                "faculty": null
                            }
                        ]
                    },
                    {
                        "day": "Thursday",
                        "slots": [
                            {
                                "start_time": "08:30",
                                "end_time": "09:25",
                                "subject_code": "BCD503",
                                "subject_name": "Theory of Computation",
                                "faculty": "Dr. Nagashree N (NN)"
                            },
                            {
                                "start_time": "09:25",
                                "end_time": "10:20",
                                "subject_code": "BCD515C",
                                "subject_name": "NOSQL Databases",
                                "faculty": "Prof. Nisha S K (NSK)"
                            },
                            {
                                "start_time": "10:20",
                                "end_time": "10:40",
                                "subject_code": null,
                                "subject_name": "Coffee Break",
                                "faculty": null
                            },
                            {
                                "start_time": "10:40",
                                "end_time": "11:35",
                                "subject_code": "BCD501",
                                "subject_name": "Software Engineering & Project Management",
                                "faculty": "Prof. Lakshmi Durga N(LDN)"
                            },
                            {
                                "start_time": "11:35",
                                "end_time": "12:30",
                                "subject_code": "BRMK557",
                                "subject_name": "Research Methodology and IPR",
                                "faculty": "Prof. Anitha C S(ACS)"
                            },
                            {
                                "start_time": "12:30",
                                "end_time": "13:15",
                                "subject_code": null,
                                "subject_name": "Lunch Break",
                                "faculty": null
                            },
                            {
                                "start_time": "13:15",
                                "end_time": "14:10",
                                "subject_code": "BCD501",
                                "subject_name": "Software Engineering & Project Management",
                                "faculty": "Prof. Lakshmi Durga N(LDN)"
                            },
                            {
                                "start_time": "14:10",
                                "end_time": "15:05",
                                "subject_code": null,
                                "subject_name": "Proctor Hour",
                                "faculty": null
                            },
                            {
                                "start_time": "15:05",
                                "end_time": "16:10",
                                "subject_code": null,
                                "subject_name": "FORUM ACTIVITY",
                                "faculty": null
                            }
                        ]
                    },
                    {
                        "day": "Friday",
                        "slots": [
                            {
                                "start_time": "08:30",
                                "end_time": "09:25",
                                "subject_code": "BCD501",
                                "subject_name": "Software Engineering & Project Management",
                                "faculty": "Prof. Lakshmi Durga N(LDN)"
                            },
                            {
                                "start_time": "09:25",
                                "end_time": "10:20",
                                "subject_code": "BCD502",
                                "subject_name": "Computer Networks",
                                "faculty": "Dr. G Dhivyasri (GD)"
                            },
                            {
                                "start_time": "10:20",
                                "end_time": "10:40",
                                "subject_code": null,
                                "subject_name": "Coffee Break",
                                "faculty": null
                            },
                            {
                                "start_time": "10:40",
                                "end_time": "11:35",
                                "subject_code": "BCD503",
                                "subject_name": "Theory of Computation",
                                "faculty": "Dr. Nagashree N (NN)"
                            },
                            {
                                "start_time": "11:35",
                                "end_time": "12:30",
                                "subject_code": "BCD515C",
                                "subject_name": "NOSQL Databases",
                                "faculty": "Prof. Nisha S K (NSK)"
                            },
                            {
                                "start_time": "12:30",
                                "end_time": "13:15",
                                "subject_code": null,
                                "subject_name": "Lunch Break",
                                "faculty": null
                            },
                            {
                                "start_time": "13:15",
                                "end_time": "14:10",
                                "subject_code": "BCD503",
                                "subject_name": "Theory of Computation",
                                "faculty": "Dr. Nagashree N (NN)",
                                "note": "Remedial Class"
                            },
                            {
                                "start_time": "14:10",
                                "end_time": "15:05",
                                "subject_code": "BCD501",
                                "subject_name": "Software Engineering & Project Management",
                                "faculty": "Prof. Lakshmi Durga N(LDN)",
                                "note": "Remedial Class"
                            },
                            {
                                "start_time": "15:05",
                                "end_time": "16:10",
                                "subject_code": null,
                                "subject_name": "NSS/YOGA/SPORTS",
                                "faculty": null
                            }
                        ]
                    },
                    {
                        "day": "Saturday",
                        "slots": []
                    }
                ]
            }
        ];

        // Time slots for the grid
        const timeSlots = [
            "08:30-09:25", "09:25-10:20", "10:20-10:40", "10:40-11:35", 
            "11:35-12:30", "12:30-13:15", "13:15-14:10", "14:10-15:05", "15:05-16:10"
        ];

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        // Timetable Cell Component
        const TimetableCell = ({ slot, day, timeIndex, onUpdate, onAddSlot, onRemoveSlot }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                subject_code: slot?.subject_code || '',
                subject_name: slot?.subject_name || '',
                faculty: slot?.faculty || '',
                note: slot?.note || ''
            });

            const getCellClass = () => {
                if (!slot) return 'timetable-cell bg-gray-100 border-gray-200';
                
                if (slot.subject_name?.includes('Coffee Break')) return 'timetable-cell coffee-cell';
                if (slot.subject_name?.includes('Lunch Break')) return 'timetable-cell lunch-cell';
                if (slot.subject_name?.includes('Lab')) return 'timetable-cell lab-cell';
                if (slot.subject_code) return 'timetable-cell subject-cell';
                return 'timetable-cell break-cell';
            };

            const handleSave = () => {
                if (slot) {
                    onUpdate(day, timeIndex, editData);
                } else {
                    onAddSlot(day, timeIndex, editData);
                }
                setIsEditing(false);
            };

            const handleCancel = () => {
                setEditData({
                    subject_code: slot?.subject_code || '',
                    subject_name: slot?.subject_name || '',
                    faculty: slot?.faculty || '',
                    note: slot?.note || ''
                });
                setIsEditing(false);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') handleSave();
                if (e.key === 'Escape') handleCancel();
            };

            return (
                <motion.div
                    className={`${getCellClass()} ${isEditing ? 'editing' : ''} p-2 border rounded-lg cursor-pointer min-h-[80px] relative`}
                    whileHover={{ scale: 1.02 }}
                    whileTap={{ scale: 0.98 }}
                    onClick={() => setIsEditing(true)}
                    layout
                >
                    {isEditing ? (
                        <div className="space-y-2">
                            <input
                                type="text"
                                placeholder="Subject Code"
                                value={editData.subject_code}
                                onChange={(e) => setEditData({...editData, subject_code: e.target.value})}
                                onKeyPress={handleKeyPress}
                                className="w-full px-2 py-1 text-xs border rounded"
                                autoFocus
                            />
                            <input
                                type="text"
                                placeholder="Subject Name"
                                value={editData.subject_name}
                                onChange={(e) => setEditData({...editData, subject_name: e.target.value})}
                                onKeyPress={handleKeyPress}
                                className="w-full px-2 py-1 text-xs border rounded"
                            />
                            <input
                                type="text"
                                placeholder="Faculty"
                                value={editData.faculty}
                                onChange={(e) => setEditData({...editData, faculty: e.target.value})}
                                onKeyPress={handleKeyPress}
                                className="w-full px-2 py-1 text-xs border rounded"
                            />
                            <input
                                type="text"
                                placeholder="Note (optional)"
                                value={editData.note}
                                onChange={(e) => setEditData({...editData, note: e.target.value})}
                                onKeyPress={handleKeyPress}
                                className="w-full px-2 py-1 text-xs border rounded"
                            />
                            <div className="flex gap-1">
                                <button
                                    onClick={handleSave}
                                    className="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                >
                                    Save
                                </button>
                                <button
                                    onClick={handleCancel}
                                    className="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                    Cancel
                                </button>
                                {slot && (
                                    <button
                                        onClick={() => onRemoveSlot(day, timeIndex)}
                                        className="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                    >
                                        Remove
                                    </button>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="h-full flex flex-col justify-center">
                            {slot ? (
                                <>
                                    <div className="font-semibold text-sm text-gray-800">
                                        {slot.subject_code}
                                    </div>
                                    <div className="text-xs text-gray-600 mt-1">
                                        {slot.subject_name}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {slot.faculty}
                                    </div>
                                    {slot.note && (
                                        <div className="text-xs text-blue-600 mt-1 font-medium">
                                            {slot.note}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="text-gray-400 text-xs text-center">
                                    Click to add
                                </div>
                            )}
                        </div>
                    )}
                </motion.div>
            );
        };

        // Main Timetable Component
        const TimetableContainer = () => {
            const [timetable, setTimetable] = useState(timetableData[0]);
            const [selectedSection, setSelectedSection] = useState('A');
            const [socket, setSocket] = useState(null);

            // Initialize socket connection
            useEffect(() => {
                const newSocket = io();
                setSocket(newSocket);

                // Listen for timetable updates
                newSocket.on('timetable_update', (data) => {
                    setTimetable(data);
                });

                return () => newSocket.close();
            }, []);

            // Auto-save function
            const autoSave = useCallback(async (updatedTimetable) => {
                try {
                    const response = await fetch('/api/timetable', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(updatedTimetable)
                    });

                    if (response.ok) {
                        // Emit update to other clients
                        if (socket) {
                            socket.emit('timetable_update', updatedTimetable);
                        }
                    }
                } catch (error) {
                    console.error('Auto-save failed:', error);
                }
            }, [socket]);

            // Update slot
            const updateSlot = (day, timeIndex, newData) => {
                const updatedTimetable = { ...timetable };
                const dayIndex = updatedTimetable.timetable.findIndex(d => d.day === day);
                
                if (dayIndex !== -1) {
                    updatedTimetable.timetable[dayIndex].slots[timeIndex] = {
                        ...updatedTimetable.timetable[dayIndex].slots[timeIndex],
                        ...newData
                    };
                    
                    setTimetable(updatedTimetable);
                    autoSave(updatedTimetable);
                }
            };

            // Add slot
            const addSlot = (day, timeIndex, newData) => {
                const updatedTimetable = { ...timetable };
                const dayIndex = updatedTimetable.timetable.findIndex(d => d.day === day);
                
                if (dayIndex !== -1) {
                    const timeSlot = timeSlots[timeIndex];
                    const [start_time, end_time] = timeSlot.split('-');
                    
                    const newSlot = {
                        start_time,
                        end_time,
                        ...newData
                    };
                    
                    updatedTimetable.timetable[dayIndex].slots[timeIndex] = newSlot;
                    
                    setTimetable(updatedTimetable);
                    autoSave(updatedTimetable);
                }
            };

            // Remove slot
            const removeSlot = (day, timeIndex) => {
                const updatedTimetable = { ...timetable };
                const dayIndex = updatedTimetable.timetable.findIndex(d => d.day === day);
                
                if (dayIndex !== -1) {
                    updatedTimetable.timetable[dayIndex].slots[timeIndex] = null;
                    
                    setTimetable(updatedTimetable);
                    autoSave(updatedTimetable);
                }
            };

            // Switch section
            const switchSection = (section) => {
                const sectionData = timetableData.find(t => t.section === section);
                if (sectionData) {
                    setTimetable(sectionData);
                    setSelectedSection(section);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6">
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-gray-800">
                                Class V 'A' SEC CSE (Data Science), ODD Semester 2025–26
                            </h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => switchSection('A')}
                                    className={`px-4 py-2 rounded-lg font-medium ${
                                        selectedSection === 'A' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Section A
                                </button>
                                <button
                                    onClick={() => switchSection('B')}
                                    className={`px-4 py-2 rounded-lg font-medium ${
                                        selectedSection === 'B' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Section B
                                </button>
                            </div>
                        </div>
                        <div className="text-sm text-gray-600">
                            Room: {timetable.room} | Academic Year: {timetable.academic_year}
                        </div>
                    </div>

                    {/* Timetable Grid */}
                    <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                            <thead>
                                <tr>
                                    <th className="w-24 p-3 bg-gray-100 border border-gray-300 text-left font-semibold text-gray-700">
                                        Time
                                    </th>
                                    {days.map(day => (
                                        <th key={day} className="w-32 p-3 bg-gray-100 border border-gray-300 text-center font-semibold text-gray-700">
                                            {day}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {timeSlots.map((timeSlot, timeIndex) => (
                                    <tr key={timeIndex}>
                                        <td className="p-3 bg-gray-50 border border-gray-300 text-center font-medium text-gray-700">
                                            {timeSlot}
                                        </td>
                                        {days.map(day => {
                                            const dayData = timetable.timetable.find(d => d.day === day);
                                            const slot = dayData?.slots[timeIndex] || null;
                                            
                                            return (
                                                <td key={`${day}-${timeIndex}`} className="p-2 border border-gray-300">
                                                    <TimetableCell
                                                        slot={slot}
                                                        day={day}
                                                        timeIndex={timeIndex}
                                                        onUpdate={updateSlot}
                                                        onAddSlot={addSlot}
                                                        onRemoveSlot={removeSlot}
                                                    />
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Legend */}
                    <div className="mt-6 flex flex-wrap gap-4 text-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded subject-cell"></div>
                            <span>Subject</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded lab-cell"></div>
                            <span>Lab</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded coffee-cell"></div>
                            <span>Coffee Break</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded lunch-cell"></div>
                            <span>Lunch Break</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 rounded break-cell"></div>
                            <span>Other Activities</span>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<TimetableContainer />, document.getElementById('root'));
    </script>
</body>
</html>
